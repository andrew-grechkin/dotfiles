#!/usr/bin/env bash

set -Eeuo pipefail

# Git hook to automatically suggest commit messages using AI
# This hook runs before the commit message editor is opened

# Arguments: $1 = commit message file, $2 = commit source (optional), $3 = commit SHA (optional)
commit_msg_file="$1"
commit_source="${2:-}"

# Only run for normal commits (not merge, squash, etc.)
if [[ -n "$commit_source" ]]; then
	exit 0
fi

# Check if ai-suggest-commit-message script is available
if ! command -v ai-suggest-commit-message >/dev/null 2>&1; then
	echo "Warning: ai-suggest-commit-message script not found in PATH" >&2
	exit 0
fi

# Check if there are staged changes
if ! git diff --cached --quiet 2>/dev/null; then
	echo "Generating AI commit message suggestion..." >&2

	# Generate commit message and write to file
	if ai-suggest-commit-message > "$commit_msg_file.ai" 2>/dev/null; then
		# Replace the default commit message with AI suggestion
		mv "$commit_msg_file.ai" "$commit_msg_file"
		echo "AI commit message suggestion generated." >&2
	else
		echo "Warning: Failed to generate AI commit message suggestion" >&2
		# Clean up failed attempt
		rm -f "$commit_msg_file.ai"
	fi
fi

exit 0
