#!/usr/bin/env bash

set -Eeuo pipefail

[[ "${ALLOW_SECRETS_IN_COMMIT:-0}" == "0" ]] || exit 0

if git rev-parse --verify HEAD >/dev/null 2>&1; then
    against=HEAD
else
    against=$(git hash-object -t tree /dev/null)
fi

patterns=$(cat << 'EO_PATTERNS'
-----BEGIN( [A-Z]+)? PRIVATE KEY-----
api[_-]?key.*[=:][[:space:]]*["\047][a-zA-Z0-9_-]{20,}["\047]
password.*[=:][[:space:]]*["\047][^"\047]{8,}["\047]
secret.*[=:][[:space:]]*["\047][a-zA-Z0-9_-]{20,}["\047]
token.*[=:][[:space:]]*["\047][a-zA-Z0-9_-]{20,}["\047]
aws_access_key_id
aws_secret_access_key
EO_PATTERNS
)

help_message=$(cat << 'EO_HELP'
To bypass this check (if this is a false positive):
  ALLOW_SECRETS_IN_COMMIT=1 git commit

Or skip this hook once:
  git commit --no-verify
EO_HELP
)

if output=$(git diff --cached --diff-filter=AMR "$against" | grep --color=always -Eif <(echo "$patterns")); then
    echo "Error: Potential secret or credential detected in staged changes"
    echo
    echo "$output"
    echo
    echo "$help_message"
    exit 1
fi

exit 0
