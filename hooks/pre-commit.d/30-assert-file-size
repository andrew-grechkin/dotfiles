#!/usr/bin/env bash

set -Eeuo pipefail

if git rev-parse --verify HEAD >/dev/null 2>&1; then
    against=HEAD
else
    against=$(git hash-object -t tree /dev/null)
fi

max_size=$(git config --int hooks.maxfilesize || echo 5242880)

EFBIG=27
ecode='0'
while IFS= read -r -d '' _mode _hash _stage path; do
    size=$(stat -c %s "$path" 2>/dev/null || stat -f %z "$path" 2>/dev/null || echo 0)
    if (( size > max_size )); then
        size_mb=$(( size / 1048576 ))
        max_mb=$(( max_size / 1048576 ))
        echo "Error: File exceeds size limit: $path ($size_mb MB > $max_mb MB)"
        ecode="$EFBIG"
    fi
done < <(git diff --cached --diff-filter=AMR --name-only -z "$against" | xargs -0 git ls-files -s -z)

[[ "$ecode" == '0' ]] || cat << 'EO_HELP'

Large files should not be committed to git.
Consider using Git LFS or storing files externally.

To change the size limit (in bytes):
  git config hooks.maxfilesize 10485760

Or skip this hook once:
  git commit --no-verify
EO_HELP

exit "$ecode"
