#!/usr/bin/env zsh

# vim: filetype=sh
# man: zshexpn

set -Euo pipefail

source "$HOME/.local/lib/shell/color.bash"

if [[ "$#" -eq "1" ]] && [[ "$1" =~ \.git/?$ ]]; then
	REPO=$(dirname "$1")

	if [[ -n "$(git -C "$REPO" branch --show-current)" ]]; then
		echo "$FG[olive]Updating ${REPO}$FX[reset]"

		git -C "$REPO" -c color.ui=always fetch --force      \
			&& nice git -C "$REPO" -c color.ui=always bleach \
			&& nice git -C "$REPO" -c color.ui=always pull
	fi
else
	fd -uL -0 -E 'bazel-*' -td -tf '\A\.git\z' "${1:-$PWD}" | sort -z | {
		if [[ -n "$(command -v parallel)" ]]; then
			parallel -j-2 --delay 0.3 -0 "$0" {}
		else
			xargs -0 --max-args=1 --no-run-if-empty "$0"
		fi
	}
fi

exit 0
