#!/usr/bin/env bash

set -Eeuo pipefail

[[ -x "$(command -v jq)" ]] || {
	echo "jq is not installed. Please install from 'https://jqlang.github.io/jq/download/'"
	exit 1
}

formatter='| jq --indent 2 -S'
colorizer=''
color='auto'

eval set -- "$(getopt --options 'c:' --longoptions 'color:' -- "$@")"

# shellcheck disable=SC2078
while [ : ]; do
	case "$1" in
		-c | --color)
			color="$2"
			shift 2
			;;
		--) shift;
			break
			;;
	esac
done

if [[ -t 1 || "$color" == 'always' ]]; then
	if [[ -x "$(command -v json2yaml)" ]]; then
		formatter="| json2yaml"
		LANGUAGE="yaml"
	elif [[ -x "$(command -v yq)" ]]; then
		formatter="| yq -P -o yaml"
		LANGUAGE="yaml"
	fi

	[[ -x "$(command -v bat)" ]] && {
		if [[ -n "$*" ]]; then
			FILENAME="$*"
		else
			FILENAME="STDIN.${LANGUAGE:-json}"
		fi

		colorizer="| bat --wrap=never -l ${LANGUAGE:-json} --color="$color" --style=header --file-name='$FILENAME'"
	}
fi

bash -c "cat $* $formatter ${colorizer:-}"
