#!/usr/bin/env bash

set -Eeuo pipefail

args="$(getopt --name="$0" --options='d' --longoptions='detect-recipients' -- "$@")"
eval set -- "$args"

while ((1)); do
    case "$1" in
        -d | --detect-recipients) detect='1'; shift ;;
        --) shift; break ;;
    esac
done

CTR=0
for FILE in "$@"; do
    recipients=()

    CTR=$((CTR + 1))

    echo "Processing ($CTR/$#): $FILE"

    FILE_DIR=$(dirname "$FILE")
    if [[ -r "$FILE_DIR/.gpg-id" ]]; then
        mapfile -t FILE_RECIPIENTS < "$FILE_DIR/.gpg-id"
        if [[ -n "${FILE_RECIPIENTS[*]}" ]]; then
            recipients=("${FILE_RECIPIENTS[@]}")
        fi
    elif [[ -r ".gpg-id" ]]; then
        mapfile -t FILE_RECIPIENTS < ".gpg-id"
        if [[ -n "${FILE_RECIPIENTS[*]}" ]]; then
            recipients=("${FILE_RECIPIENTS[@]}")
        fi
    else
        if [[ -n "${detect:-}" ]]; then
            if FILE_RECIPIENTS="$(gpg-recipients "$FILE")"; then
                mapfile -t FILE_RECIPIENTS <<< "$FILE_RECIPIENTS"
                if [[ -n "${FILE_RECIPIENTS[*]}" ]]; then
                    recipients=("${FILE_RECIPIENTS[@]}")
                fi
            fi
        fi
    fi

    [[ -n "${recipients[*]}" ]] || { echo 'unable to detect recipients' >&2; exit 1; }
    gpg --quiet --decrypt "$FILE" \
        | command gpg --armor --encrypt --default-recipient-self "${recipients[@]/#/'--recipient='}" --output "${FILE}.reencrypt" \
        && mv "${FILE}.reencrypt" "$FILE"
done
